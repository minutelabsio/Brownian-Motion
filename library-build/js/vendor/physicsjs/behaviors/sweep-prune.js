/**
 * PhysicsJS v1.0.0-rc1 - 2014-04-13
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

(function(e,t){typeof define=="function"&&define.amd?define(["physicsjs"],t):typeof exports=="object"?module.exports=t.apply(e,["physicsjs"].map(require)):t.call(e,e.Physics)})(this,function(e){return e.behavior("sweep-prune",function(t){function o(e,t){return e|=0,t|=0,(e|0)===(t|0)?-1:((e|0)>(t|0)?e<<16|t&65535:t<<16|e&65535)|0}var n=1,r=function(){return n++},i={x:0,y:1},s=2;return{init:function(e){t.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(e),this.encounters=[],this.candidates=[],this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists=[];for(var e=0;e<s;++e)this.intervalLists[e]=[]},connect:function(e){e.on("add:body",this.trackBody,this),e.on("remove:body",this.untrackBody,this),e.on("integrate:velocities",this.sweep,this);var t=e.getBodies();for(var n=0,r=t.length;n<r;++n)this.trackBody({body:t[n]})},disconnect:function(e){e.off("add:body",this.trackBody),e.off("remove:body",this.untrackBody),e.off("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var e,t,n,r,i,o,u,a,f;for(var l=0;l<s;++l){e=this.intervalLists[l],n=0,t=e.length,f=l;while(++n<t){i=e[n],o=i.val.get(f),r=n,u=e[r-1],a=u&&u.val.get(f);while(r>0&&(a>o||a===o&&u.type&&!i.type))e[r]=u,r--,u=e[r-1],a=u&&u.val.get(f);e[r]=i}}},getPair:function(e,t,n){var r=o(e.id,t.id);if(r===!1)return null;var i=this.pairs[r];if(!i){if(!n)return null;i=this.pairs[r]={bodyA:e.body,bodyB:t.body,flag:1}}return i},checkOverlaps:function(){var e,t,n,r,o,u,a,f,l,c,h=1<<i.z+1<<i.y+1<<i.x+1,p=this.encounters,d=0,v=this.candidates;p.length=v.length=0;for(var m=0;m<s;++m){e=m===0,u=this.intervalLists[m];for(f=0,a=u.length;f<a;f++){o=u[f],n=o.tracker;if(o.type){l=d;for(l=d-1;l>=0;l--)r=p[l],r===n?(l<d-1?p[l]=p.pop():p.pop(),d--):(c=this.getPair(n,r,e),c&&(c.flag>h&&(c.flag=1),c.flag=c.flag<<m+1,c.flag===h&&v.push(c)))}else d=p.push(n)}}return v},updateIntervals:function(){var t,n,r=e.scratchpad(),i=r.vector(),s,o=r.vector(),u=this.tracked,a=u.length;while(--a>=0)t=u[a],n=t.interval,i.clone(t.body.state.pos),s=t.body.aabb(),o.set(s.hw,s.hh),n.min.val.clone(i).vsub(o),n.max.val.clone(i).vadd(o);r.done()},trackBody:function(t){var n=t.body,i={id:r(),body:n},o={min:{type:!1,val:e.vector(),tracker:i},max:{type:!0,val:e.vector(),tracker:i}};i.interval=o,this.tracked.push(i);for(var u=0;u<s;++u)this.intervalLists[u].push(o.min,o.max)},untrackBody:function(e){var t=e.body,n,r,i=this.tracked,o,u;for(var a=0,f=i.length;a<f;++a){o=i[a];if(o.body===t){i.splice(a,1);for(var l=0;l<s;++l){u=0,n=this.intervalLists[l];for(var c=0,h=n.length;c<h;++c){r=n[c];if(r===o.interval.min||r===o.interval.max){n.splice(c,1),c--,f--;if(u>0)break;u++}}}break}}},sweep:function(e){var t=this,n;n=t.broadPhase(),n.length&&this._world.emit(this.options.channel,{candidates:n})}}}),e});